input {
  beats {
    port => 5044
  }
}

filter {
  if [container][name] =~ /crapi/ {
    mutate {
      add_field => { "service_type" => "crapi" }
    }
  }
  
  if [container][name] =~ /wazuh/ {
    mutate {
      add_field => { "service_type" => "wazuh" }
    }
  }

  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # Add timestamp
  date {
    match => [ "@timestamp", "ISO8601" ]
  }

  # Detect security events
  if [message] =~ /(error|exception|fail|attack|injection|xss|unauthorized|403|404|500)/ {
    mutate {
      add_field => { "security_event" => "true" }
      add_field => { "alert_level" => "medium" }
    }
  }

  if [message] =~ /(sql.*injection|script.*alert|command.*injection|path.*traversal)/ {
    mutate {
      add_field => { "security_event" => "true" }
      add_field => { "alert_level" => "high" }
    }
  }
}

output {
  # Send to OpenSearch
  opensearch {
    hosts => ["opensearch:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    template_name => "logs"
    template => {
      "index_patterns" => ["logs-*"]
      "settings" => {
        "number_of_shards" => 1
        "number_of_replicas" => 0
      }
      "mappings" => {
        "properties" => {
          "@timestamp" => { "type" => "date" }
          "message" => { "type" => "text" }
          "service_type" => { "type" => "keyword" }
          "security_event" => { "type" => "boolean" }
          "alert_level" => { "type" => "keyword" }
          "container" => {
            "properties" => {
              "name" => { "type" => "keyword" }
              "image" => { "type" => "keyword" }
            }
          }
        }
      }
    }
  }

  # Send security events to Wazuh
  if [security_event] == "true" {
    tcp {
      host => "wazuh.manager"
      port => 1514
      codec => json_lines
    }
  }
}
